<!DOCTYPE html>

<head>
  <title>Basiner</title>
  <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Scope boulders in the basin">
  <meta name="keywords"
    content="Ewbank, climbing grades, sport climbing, grade converter, climbing scale, Australia, New Zealand, climbing tool">
  <meta name="author" content="Derek Thatcher @ castlehillbasin.co.nz">
  <meta property="og:image" content="chb.png" />
  <meta property="og:image:secure_url" content="chb.png" />
  <meta name="MobileOptimized" content="width" />
  <meta name="HandheldFriendly" content="true" />
  <link rel="icon" type="image/x-icon" href="/basiner/favicon.ico">
  <style>
    @import url('https://fonts.googleapis.com/css?family=Barlow|Barlow+Condensed|Barlow+Semi+Condensed&display=swap');

    body {
      margin: 0;
      font-family: Barlow;
    }

    #header {
      position: fixed;
      z-index: 1000;
    }

    #seadragon-viewer {
      width: 100vw;
      height: 100vh;
    }

    ul {
      list-style: none;
      margin-top: 0px;
      padding-left: 0;
      margin-bottom: 1px;
    }

    ul li {
      display: inline-block;
      background-color: black;
      color: white;
      width: 19px;
      height: 19px;
      text-align: center;
      margin-bottom: 3px;
    }

    /* Sidebar Menu Styling */
    #sidebar-menu {
      width: 130px;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow-y: auto;
      background-color: #000;
    }

    /* "Images" toggle button styling */
    #toggle-images-menu {
      background-color: #000;
      color: white;
      border: none;
      cursor: pointer;
      text-align: left;
      width: 100%;
      font-family: Barlow;
      transition: background-color 0.2s ease;
      padding: 4px;
    }

    #toggle-images-menu:hover {
      background-color: #111;
      /* Darker blue on hover */
    }

    /* Container for the list of image links */
    #image-links-container {
      margin-top: 0.5rem;
      display: none;
      flex-direction: column;
      gap: 0.2rem;
      transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
      max-height: 0;
      opacity: 0;
      overflow: hidden;
    }

    #image-links-container.open {
      display: flex;
      max-height: 500px;
      opacity: 1;
    }

    /* Styling for individual image links */
    .image-link-item {
      color: #ecf0f1;
      padding: 0.2rem 0.5rem;
      cursor: pointer;
      transition: background-color 0.2s ease, color 0.2s ease;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 0.9rem;
    }

    .image-link-item:hover {
      background-color: #333;
      color: #ffffff;
    }
  </style>
</head>

<body>
  <div id="header">
    <img src="chb.png" width="131px">
    <ul>
      <li id="out" alt="zoom out">-</li>
      <li id="in">+</li>
      <li id="home">H</li>
      <li id="full">F</li>
      <li id="previous">
        < </li>
      <li id="next">></li>
    </ul>

    <div id="sidebar-menu">
      <button id="toggle-images-menu">Links</button>
      <div id="image-links-container">
        <!-- Image links will be dynamically inserted here by JavaScript -->
      </div>
    </div>
  </div>
  <div id="seadragon-viewer"></div>
  <script src="//openseadragon.github.io/openseadragon/openseadragon.min.js"></script>
  <script>
    // 1. Helper to turn titles into URL-friendly "slugs"
    const slugify = (text) => text.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g, '');

    // run vips dzsave input_image.png output_tiles
    let imageList = [
      { url: "kuratawhiti/tiles.dzi", title: "Kura Tawhiti" },
      { url: "q2/tiles.dzi", title: "Kura Tawhiti 2" },
      { url: "q3/q3.dzi", title: "Kura Tawhiti 3" },
      { url: "q4/q4.dzi", title: "Kura Tawhiti 4" },
      { url: "s1/s1.dzi", title: "Spittle Hill" },
      { url: "teapot/tiles.dzi", title: "The Teapot" },
      { url: "t2/tiles.dzi", title: "The Teapot 2" },
      { url: "t3/t3.dzi", title: "The Teapot 3" },
      { url: "t4/t4.dzi", title: "The Teapot 4" },
      { url: "t5/t5.dzi", title: "The Teapot 5" },
      { url: "t6/t6.dzi", title: "The Teapot 6" },
      { url: "f1/tiles.dzi", title: "Flock Hill 1" },
      { url: "f2/tiles.dzi", title: "Flock Hill 2" },
      { url: "f3/f3.dzi", title: "Flock Hill 3" },
      { url: "f4/f4.dzi", title: "Flock Hill 4" },
      { url: "f5/f5.dzi", title: "Flock Hill 5" },
      { url: "f6/f6.dzi", title: "Flock Hill 6" },
      { url: "f7/f7.dzi", title: "Flock Hill 7" },
      { url: "d1/d1.dzi", title: "Dry Valley" },
      { url: "w1/tiles.dzi", title: "Wuthering Heights 1" },
      { url: "w2/tiles.dzi", title: "Wuthering Heights 2" },
      { url: "w3/tiles.dzi", title: "Annie Oakley" },
      { url: "village/tiles.dzi", title: "Castle Hill Village" }
    ];

    // 2. Check the URL on load to see if a specific image is requested
    const urlParams = new URLSearchParams(window.location.search);
    const initialSlug = urlParams.get('img');
    console.log(initialSlug);
    let initialPageIndex = imageList.findIndex(img => slugify(img.title) === initialSlug);
    if (initialPageIndex === -1) initialPageIndex = 0; // Default to first image

    var viewer = OpenSeadragon({
      id: "seadragon-viewer",
      prefixUrl: "//openseadragon.github.io/openseadragon/images/",
      tileSources: imageList.map(source => source.url),
      initialPage: initialPageIndex, // Start at the URL-specified image
      showNavigator: true,
      sequenceMode: true,
      zoomInButton: "in",
      zoomOutButton: "out",
      homeButton: "home",
      fullPageButton: "full",
      nextButton: "next",
      previousButton: "previous",
    });

    // 3. Update the URL whenever the page changes
    viewer.addHandler('page', function(event) {
      const currentImage = imageList[event.page];
      const newSlug = slugify(currentImage.title);
      
      // Update the URL without reloading the page
      const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?img=' + newSlug;
      window.history.replaceState({ path: newUrl }, '', newUrl);
    });

    // Get references to menu elements
    const toggleButton = document.getElementById('toggle-images-menu');
    const imageLinksContainer = document.getElementById('image-links-container');

    // Dynamically create image links
    imageList.forEach((image, index) => {
      const linkItem = document.createElement('div');
      linkItem.className = 'image-link-item';
      linkItem.textContent = image.title;
      linkItem.dataset.index = index; // Store the index for navigation

      linkItem.addEventListener('click', () => {
        viewer.goToPage(index);
        // Optionally close the menu after clicking a link
        imageLinksContainer.classList.remove('open');
      });
      imageLinksContainer.appendChild(linkItem);
    });

    // Toggle visibility of image links on button click
    toggleButton.addEventListener('click', () => {
      imageLinksContainer.classList.toggle('open');
    });
  </script>
</body>